name: Backfill Missing Links

on:
  # Only allow manual triggering
  workflow_dispatch:
    inputs:
      start_date:
        description: 'Start date (YYYY-MM-DD) - leave empty for 30 days ago'
        required: false
        type: string
      end_date:
        description: 'End date (YYYY-MM-DD) - leave empty for yesterday'
        required: false
        type: string
      dry_run:
        description: 'Dry run (show what would be created without actually creating)'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  actions: write

jobs:
  backfill:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Run backfill script
        env:
          BLUESKY_HANDLE: ${{ secrets.BLUESKY_HANDLE }}
          BLUESKY_APP_PASSWORD: ${{ secrets.BLUESKY_APP_PASSWORD }}
        run: |
          ARGS=""
          if [ -n "${{ inputs.start_date }}" ]; then
            ARGS="$ARGS --start-date ${{ inputs.start_date }}"
          fi
          if [ -n "${{ inputs.end_date }}" ]; then
            ARGS="$ARGS --end-date ${{ inputs.end_date }}"
          fi
          if [ "${{ inputs.dry_run }}" = "true" ]; then
            ARGS="$ARGS --dry-run"
          fi
          python _scripts/backfill_missing_links.py $ARGS

      - name: Check for new posts
        id: check_changes
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            echo "changes=true" >> $GITHUB_OUTPUT
          else
            echo "changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push if posts were created
        if: steps.check_changes.outputs.changes == 'true' && inputs.dry_run != true
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git add _posts/
          git commit -m "Backfill missing links posts [automated]"
          git push

      - name: Trigger Jekyll deployment
        if: steps.check_changes.outputs.changes == 'true' && inputs.dry_run != true
        run: |
          curl -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/${{ github.repository }}/actions/workflows/jekyll.yml/dispatches \
            -d '{"ref":"master"}'
